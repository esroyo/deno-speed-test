<body>
  <div id="controls"></div>
  <div id="result"></div>

  <script type="module">
    import SpeedTest from 'https://cdn.skypack.dev/@cloudflare/speedtest';

    const controlEl = document.getElementById('controls');
    const resEl = document.getElementById('result');

    const REL_API_URL = window.location.origin;
    const engine = new SpeedTest({
      autoStart: false,
      downloadApiUrl: `${REL_API_URL}/__down`,
      uploadApiUrl: `${REL_API_URL}/__up`,
      logMeasurementApiUrl: null,
      logAimApiUrl: null,
      turnServerUri: null,
      turnServerCredsApiUrl: `${REL_API_URL}/__turn`,
      turnServerUser: null,
      turnServerPass: null,
      rpkiInvalidHost: null,
      cfTraceUrl: null,
      includeCredentials: false,
    });
    engine.onRunningChange = running => controlEl.textContent = running ? 'Running...' : 'Finished!';
    engine.onResultsChange = ({ type }) => {
      !engine.isFinished && setResult(engine.results.raw);
      console.log(type);
    };
    engine.onFinish = results => {
      setResult(results.getSummary());
      console.log(results.getSummary());
      console.log(results.getScores());
    };

    engine.onError = (e) => console.log(e);

    const playButton = document.createElement('button');
    playButton.textContent = "Start Speed Measurement";
    playButton.onclick = () => engine.play();
    controlEl.appendChild(playButton);

    function setResult(obj) {
      const resTxt = document.createElement('pre');
      resTxt.textContent = JSON.stringify(obj, null, 2);
      resEl.textContent = '';
      resEl.appendChild(resTxt);
    }
  </script>
</body>
